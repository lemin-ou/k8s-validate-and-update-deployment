apiVersion: batch/v1
kind: Job
metadata:
  name: k8s-update-deployment-ecr-tag-setup
  namespace: kube-system
spec:
  template:
    spec:
      serviceAccountName: k8s-update-deployment-ecr-tag
      containers:
      - name: k8s-update-deployment-ecr-tag-setup
        # This is a minimal kubectl image based on Alpine Linux that signs certificates using the k8s extension api server
        image: quay.io/didil/k8s-webhook-cert-manager:0.13.19-1-a
        command: ["./generate_certificate.sh"]
        args:
          - "--service"
          - "k8s-update-deployment-ecr-tag"
          - "--webhook"
          - "k8s-update-deployment-ecr-tag"
          - "--secret"
          - "k8s-update-deployment-ecr-tag-secret"
          - "--namespace"
          - "kube-system"
      restartPolicy: OnFailure
  backoffLimit: 3